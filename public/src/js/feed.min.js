var picture,fetchedLocation,shareImageButton=document.querySelector("#share-image-button"),createPostArea=document.querySelector("#create-post"),closeCreatePostModalButton=document.querySelector("#close-create-post-modal-btn"),sharedMomentsArea=document.querySelector("#shared-moments"),form=document.querySelector("form"),inputTitle=document.querySelector("#title"),inputLocation=document.querySelector("#location"),videoPlayer=document.querySelector("#player"),canvasPlayer=document.querySelector("#canvas"),captureBtn=document.querySelector("#capture-btn"),imagePicker=document.querySelector("#image-picker"),imagePickerArea=document.querySelector("#pick-image"),locationBtn=document.querySelector("#location-btn"),locationLoader=document.querySelector("#location-loader");function initializeLocation(){"geolocation"in navigator||(locationBtn.style.display="none")}function initializeMedia(){"mediaDevices"in navigator||(navigator.mediaDevices={}),"getUserMedia"in navigator.mediaDevices||(navigator.mediaDevices.getUserMedia=o=>{let a=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return a?new Promise((e,t)=>{a.call(navigator,o,e,t)}):Promise.reject(new Error("getUserMedia is not implemented!"))}),navigator.mediaDevices.getUserMedia({video:!0}).then(e=>{console.log(e),videoPlayer.srcObject=e,videoPlayer.style.display="block"}).catch(e=>{console.error(e),imagePickerArea.style.display="block",captureBtn.style.display="none"})}function openCreatePostModal(){setTimeout(()=>{createPostArea.style.transform="translateY(0)"},1),initializeMedia(),initializeLocation(),console.log("deferredPrompt",deferredPrompt),deferredPrompt&&(deferredPrompt.prompt(),deferredPrompt.userChoice.then(e=>{console.log("choiceResult",e.outcome),"dismissed"===e.outcome?console.log("User cancelled installation"):console.log("User added to home screen")}),deferredPrompt=null)}function closeCreatePostModal(){console.log("closeCreatePostModal"),videoPlayer.style.display="none",imagePickerArea.style.display="none",canvasPlayer.style.display="none",locationBtn.style.display="inline",locationLoader.style.display="none",captureBtn.style.display="inline",inputLocation.value="",inputTitle.value="",videoPlayer.srcObject&&videoPlayer.srcObject.getVideoTracks().forEach(e=>{e.stop()}),setTimeout(()=>{createPostArea.style.transform="translateY(100vh)"},1)}function onSaveButtonClicked(e){console.log("clicked")}function createCard(e){var t=document.createElement("div");t.className="shared-moment-card mdl-card mdl-shadow--2dp";var o=document.createElement("div");o.className="mdl-card__title",o.style.backgroundImage=`url("${e.image}")`,o.style.backgroundSize="cover",o.style.height="180px",o.style.backgroundPosition="bottom",t.appendChild(o);var a=document.createElement("h2");a.className="mdl-card__title-text",a.textContent=e.title,o.appendChild(a);a=document.createElement("div");a.className="mdl-card__supporting-text",a.textContent=e.location,a.style.textAlign="center",t.appendChild(a),componentHandler.upgradeElement(t),sharedMomentsArea.appendChild(t)}function mountCardData(e){var t,o=[];for(t in e)o.push(e[t]);return o}function updateUI(e){e.forEach(createCard)}locationBtn.addEventListener("click",e=>{var t;"geolocation"in navigator&&(t=!1,locationBtn.style.display="none",locationLoader.style.display="block",navigator.geolocation.getCurrentPosition(e=>{locationBtn.style.display="inline",locationLoader.style.display="none",fetchedLocation={latitude:e.coords.latitude,longitude:e.coords.longitude},inputLocation.value="In Munich",inputLocation.classList.add("is-focused")},e=>{t||(t=!0,alert("Couldn't fetch location, please enter manually!")),locationBtn.style.display="inline",locationLoader.style.display="none",console.error(e),fetchedLocation=null},{timeout:7e3}))}),captureBtn.addEventListener("click",e=>{console.log("captureBtn - click"),canvasPlayer.style.display="block",videoPlayer.style.display="none",captureBtn.style.display="none";const t=canvasPlayer.getContext("2d");t.drawImage(videoPlayer,0,0,canvas.width,videoPlayer.videoHeight/(videoPlayer.videoWidth/canvas.width)),picture=dataURItoBlob(canvasPlayer.toDataURL())}),imagePicker.addEventListener("change",e=>{picture=e.target.files[0]}),shareImageButton.addEventListener("click",openCreatePostModal),closeCreatePostModalButton.addEventListener("click",closeCreatePostModal);var url="https://ficha-academia-web-top.firebaseio.com/posts.json",networkDataReceived=!1;function sendData(){var e={id:(new Date).toISOString(),title:inputTitle.value,location:inputLocation.value};const t=new FormData;t.append("id",e.id),t.append("title",e.title),t.append("location",e.location),t.append("file",picture,e.id+".png"),t.append("rawLocation",JSON.stringify(fetchedLocation)),fetch(url,{method:"post",body:t}).then(function(e){console.log("Send Data",e),updateUI()})}fetch(url).then(function(e){return e.json()}).then(function(e){networkDataReceived=!0,console.log("From web",e),updateUI(mountCardData(e))}),"indexDB"in window&&readData().then(function(e){networkDataReceived||(console.log("From IDB",e),updateUI(e))}),form.addEventListener("submit",function(e){e.preventDefault(),inputTitle.value.trim()&&inputLocation.value.trim()?(closeCreatePostModal(),"serviceWorker"in navigator&&"SyncManager"in window?navigator.serviceWorker.ready.then(function(e){var t={id:(new Date).toISOString(),title:inputTitle.value,location:inputLocation.value,picture:picture,rawLocation:JSON.stringify(fetchedLocation)};writeData(t,"sync-posts").then(function(){return console.log("register stored in sync-post"),e.sync.register("sync-new-posts")}).then(function(){const e=document.querySelector("#confirmation-toast");e.MaterialSnackbar.showSnackbar({message:"Your post was saved for syncing!"})}).catch(function(e){console.log(e)})}):sendData()):alert("Please enter valid data!")});